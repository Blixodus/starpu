.PHONY: tags drivers examples common core tools tests task-models datawizard

export 

CC=gcc -m64
NVCC = nvcc -m64
NVCCFLAGS += -O3

CFLAGS += @CPPFLAGS@
CFLAGS += @CFLAGS@
LDFLAGS += @LDFLAGS@
EXTRALDFLAGS += @LIBS@

CFLAGS += -I${PWD}/include/

CFLAGS += -g -O3
CFLAGS += -W -Wall -Wimplicit -Wswitch -Wformat -Wchar-subscripts -Wparentheses
CFLAGS += -Wmultichar -Wtrigraphs -Wpointer-arith -Wcast-align -Wreturn-type 
CFLAGS += -Wno-unused-function  -Wstrict-prototypes -Wnested-externs -fno-strict-aliasing

# This will be useful for program which use CUDA (and .cubin files) which need some path
# to the CUDA code at runtime.
CFLAGS+="-DSTARPUDIR=\"$(PWD)/\""

LDFLAGS+= -lm
LDFLAGS += -lpthread

ifeq (@COVERAGE@,yes)
	CFLAGS += --coverage
	LDFLAGS += --coverage
endif

ifdef TRANSFER_OVERHEAD
	CFLAGS += -DTRANSFER_OVERHEAD
endif

ifdef PERTURB_AMPL
	CFLAGS+="-DUSE_PERTURBATION"
	CFLAGS+="-DAMPL=$(PERTURB_AMPL)"
endif

ifdef MODEL_DEBUG
	CFLAGS+="-DMODEL_DEBUG "
endif

ifdef DATA_STATS
	CFLAGS+="-DDATA_STATS "
endif

ifdef PERF_MODEL_DIR
	CFLAGS+="-DPERF_MODEL_DIR=\"$(PERF_MODEL_DIR)/\""
else
	CFLAGS+="-DPERF_MODEL_DIR=\"$(PWD)/.sampling/\""
endif

ifndef SCALPDIR
SCALPDIR=/home/gonnet/Scalp/scalp/trunk/
endif

ifeq (@PERF_DEBUG@,yes)
	CFLAGS += -DPERF_DEBUG
	LDFLAGS += -pg
	CFLAGS += -pg
endif

EXTRADEP=

ifdef NO_DATA_RW_LOCK
	CFLAGS+=-DNO_DATA_RW_LOCK
endif

#Â TODO that should be automatized, somehow
ifdef UNRELIABLETICKS
	CFLAGS += -DUNRELIABLETICKS
endif

ifdef DONTBIND
	CFLAGS += -DDONTBIND
endif

ifdef USE_OVERLOAD
	CFLAGS += -DUSE_OVERLOAD
endif

ifeq (@USE_CUDA@,yes)
	CFLAGS += -DUSE_CUDA 
	NVCCFLAGS +=  -DUSE_CUDA 
	LDFLAGS += -lcublas
	OBJDEPS += src/drivers/cuda/driver_cuda.o
endif

ifeq (@BLAS_LIB@,atlas)
	CFLAGS += -DATLAS
	OBJDEPS += src/common/blas.o
endif

ifeq (@BLAS_LIB@,goto)
	CFLAGS += -DGOTO
	OBJDEPS += src/common/blas.o
endif

ifeq (@BLAS_LIB@,system)
	CFLAGS += -DSYSTEM_BLAS
	OBJDEPS += src/common/blas.o
endif

ifeq (@USE_CPU@,yes)
	CFLAGS += -DUSE_CPUS
	CFLAGS += -DNMAXCORES=@NMAXCORES@
	NVCCFLAGS += -DUSE_CPUS
	OBJDEPS += src/drivers/core/driver_core.o
endif

ifeq (@USE_GORDON@,yes)
	CFLAGS += -I$(SCALPDIR)
	CFLAGS += -DUSE_GORDON
	LDFLAGS += -lspe2
	OBJDEPS += src/drivers/gordon/driver_gordon.o
	EXTRALDFLAGS+= $(SCALPDIR)/cell/gordon/libgordon.a
	EXTRALDFLAGS+= $(SCALPDIR)/util/libsp@ceutil.a
	EXTRALDFLAGS+= $(SCALPDIR)/util/libsp@ceutil.spu.a
endif

ifeq (@USE_FXT@,yes)
	CFLAGS += -DUSE_FXT -DCONFIG_FUT
	LDFLAGS += -lfxt 
	OBJDEPS += src/common/fxt.o
ifeq (@USE_FXTDIR_FROM_USER@,yes)
	CFLAGS += -I@FXTDIR@/include/
	LDFLAGS += -L@FXTDIR@/lib/
endif
endif

ifeq (@USE_PRIO@,no)
	CFLAGS += -DNO_PRIO
endif

#
#	To create the static and dynamic libraries, we need a list of all the object
#	files that are needed by the application which use our runtime
#

OBJDEPS += src/common/hash.o
OBJDEPS += src/common/timing.o 
OBJDEPS += src/common/htable32.o 
OBJDEPS += src/common/mutex.o
OBJDEPS += src/common/rwlock.o 
OBJDEPS += src/core/perfmodel/perfmodel.o 
OBJDEPS += src/core/perfmodel/regression.o 
OBJDEPS += src/core/perfmodel/perfmodel_history.o 
OBJDEPS += src/core/jobs.o
OBJDEPS += src/core/workers.o
OBJDEPS += src/core/dependencies/tags.o
OBJDEPS += src/core/dependencies/htable.o
OBJDEPS += src/core/dependencies/data-concurrency.o
OBJDEPS += src/core/mechanisms/queues.o
OBJDEPS += src/core/mechanisms/priority_queues.o
OBJDEPS += src/core/mechanisms/deque_queues.o
OBJDEPS += src/core/mechanisms/fifo_queues.o
OBJDEPS += src/core/policies/sched_policy.o
OBJDEPS += src/core/policies/no-prio-policy.o
OBJDEPS += src/core/policies/eager-central-policy.o
OBJDEPS += src/core/policies/eager-central-priority-policy.o
OBJDEPS += src/core/policies/work-stealing-policy.o
OBJDEPS += src/core/policies/deque-modeling-policy.o
OBJDEPS += src/core/policies/deque-modeling-policy-data-aware.o
OBJDEPS += src/core/policies/random-policy.o
OBJDEPS += src/datawizard/progress.o
OBJDEPS += src/datawizard/copy-driver.o
OBJDEPS += src/datawizard/data_request.o
OBJDEPS += src/datawizard/coherency.o 
OBJDEPS += src/datawizard/hierarchy.o 
OBJDEPS += src/datawizard/write_back.o 
OBJDEPS += src/datawizard/memalloc.o
OBJDEPS += src/datawizard/footprint.o
OBJDEPS += src/datawizard/datastats.o
OBJDEPS += src/datawizard/interfaces/blas_filters.o
OBJDEPS += src/datawizard/interfaces/csr_filters.o
OBJDEPS += src/datawizard/interfaces/bcsr_filters.o
OBJDEPS += src/datawizard/interfaces/vector_filters.o
OBJDEPS += src/datawizard/interfaces/blas_interface.o
OBJDEPS += src/datawizard/interfaces/csr_interface.o
OBJDEPS += src/datawizard/interfaces/bcsr_interface.o
OBJDEPS += src/datawizard/interfaces/vector_interface.o
OBJDEPS += src/task-models/blas_model.o

LIBS=libstarpu.a
ifeq (@DYNAMIC@,yes)
	CFLAGS+= -fPIC
	LIBS+= sbtarpu.so
endif

all:
	@make -C src/common
	@make -C src/core
	@make -C src/drivers
	@make -C src/datawizard
	@make -C src/task-models
	@make -C tools

libstarpu.so: all
	gcc --shared -o libstarpu.so $(OBJDEPS)

libstarpu.a: all
	$(AR) rcs $@ $(OBJDEPS)

libs: $(LIBS)

examples: libs
	@make -C examples

tags:
	find .|xargs ctags

clean:
	@make -C src/common clean
	@make -C src/core clean
	@make -C src/drivers clean
	@make -C src/datawizard clean
	@make -C src/task-models clean
	@make -C examples clean
	@make -C tools clean
	@rm -f *.so *.a
